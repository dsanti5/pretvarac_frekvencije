#include "stm32f401xe.h"
#include "math.h"

int cnt1=0;
int cnt2=12;
int cnt3=24;

int sin_data[240] =
{0,13,26,39,52,65,78,91,104,117,130,143,156,196,182,195,207,220,233,246,258,271,284,296,309,321,333,346,358,370,
382,394,406,418,430,442,453,465,477,488,500,511,522,533,544,555,566,577,587,598,608,619,629,639,649,659,669,678,688,697,
707,716,725,734,743,751,760,768,777,785,793,801,809,816,824,831,838,845,852,859,866,872,878,884,891,896,902,908,913,918,
923,928,933,938,942,946,951,955,958,962,965,969,972,975,978,980,983,985,987,989,991,993,994,995,996,997,998,999,999,999,
999,999,999,998,997,996,995,994,993,991,989,987,985,983,980,978,975,972,969,965,962,958,955,951,946,942,938,933,928,923,
918,913,908,902,896,891,884,878,872,866,859,852,845,838,831,824,816,809,801,793,785,777,768,760,751,743,734,725,716,707,
697,688,678,669,659,649,639,629,619,608,598,587,577,566,555,544,533,522,511,500,488,477,465,453,442,430,418,406,394,382,
370,358,346,333,321,309,296,284,271,258,246,233,220,207,195,182,196,156,143,130,117,104,91,78,65,52,39,26,13,0};
int sinek[36] = {0, 10, 20, 30, 40, 50, 60, 70, 80, 90, 100, 110, 120, 130, 140, 150, 160, 170, 180,
                180, 170, 160, 150, 140, 130, 120, 110, 100, 90, 80, 70, 60, 50, 40, 30, 20, 10};


void TIM1_UP_TIM10_IRQHandler(void){
	//Potrebno je ocistiti status registar
	TIM1-> SR &= ~(TIM_SR_UIF);

	TIM1->CCR1 = sinek[cnt1];
	if(cnt1 >= 36){
		cnt1=0;
	}
	cnt1++;
	TIM1->CCR2 = sinek[cnt2];
	if(cnt2 >= 36){
		cnt2=0;
	}
	cnt2++;
	TIM1->CCR3 = sinek[cnt3];
	if(cnt3 >= 36){
		cnt3=0;
	}
	cnt3++;
}

int main(void){

	// Enable TIM1
	RCC-> APB2ENR |= RCC_APB2ENR_TIM1EN;
	//RCC-> APB1ENR |= RCC_APB1ENR_TIM2EN;
	// Enable GPIOA i GPIOB
	RCC-> AHB1ENR |= RCC_AHB1ENR_GPIOAEN | RCC_AHB1ENR_GPIOBEN;

	// CH1
	GPIOA-> MODER &= ~(GPIO_MODER_MODER8_0);
	GPIOA-> MODER |= GPIO_MODER_MODER8_1;
	// CH1 N
	GPIOA-> MODER &= ~(GPIO_MODER_MODER7_0);
	GPIOA-> MODER |= GPIO_MODER_MODER7_1;
	// CH2
	GPIOA-> MODER &= ~(GPIO_MODER_MODER9_0);
	GPIOA-> MODER |= GPIO_MODER_MODER9_1;
	// CH2 N
	GPIOB-> MODER &= ~(GPIO_MODER_MODER0_0);
	GPIOB-> MODER |= GPIO_MODER_MODER0_1;
	// CH3
	GPIOA-> MODER &= ~(GPIO_MODER_MODER10_0);
	GPIOA-> MODER |= GPIO_MODER_MODER10_1;
	// CH3 N
	GPIOB-> MODER &= ~(GPIO_MODER_MODER1_0);
	GPIOB-> MODER |= GPIO_MODER_MODER1_1;

	GPIOA-> AFR[1] = 0x111;
	GPIOA-> AFR[0] = 0x10000000;
	GPIOB-> AFR[0] = 0x11;

	TIM1-> PSC = 4;
	TIM1-> ARR = 179;

	// Capture compare mode register 1
	TIM1-> CCMR1 |= TIM_CCMR1_OC1M_1 | TIM_CCMR1_OC1M_2 | TIM_CCMR1_OC1PE | TIM_CCMR1_OC2M_1 | TIM_CCMR1_OC2M_2 | TIM_CCMR1_OC2PE;
	// Capture compare mode register 2
	TIM1-> CCMR2 |= TIM_CCMR2_OC3M_1 | TIM_CCMR2_OC3M_2 | TIM_CCMR2_OC3PE;

	TIM1-> CCER |= TIM_CCER_CC1E | TIM_CCER_CC1NE | TIM_CCER_CC2E | TIM_CCER_CC2NE | TIM_CCER_CC3E | TIM_CCER_CC3NE;
	TIM1-> BDTR |= TIM_BDTR_DTG_3  | TIM_BDTR_DTG_2 | TIM_BDTR_DTG_1 | TIM_BDTR_DTG_0;

	// Master out enable
	TIM1-> BDTR |= TIM_BDTR_MOE;
	TIM1-> EGR |= TIM_EGR_UG;
	TIM1-> DIER |= TIM_DIER_UIE;

	// Counter enable
	TIM1-> CR1 |= TIM_CR1_CEN;
	NVIC_EnableIRQ(TIM1_UP_TIM10_IRQn);

    while(1)
    {
    }
}
